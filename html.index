<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ù…Ø­Ø§Ø¯Ø«Ø© TikTok Style</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
  <style>
    body {background:#000;color:#fff;font-family:'Segoe UI',sans-serif;transition:background 0.3s,color 0.3s;}
    section{display:none;animation:fadeIn .5s ease-in-out;} section.active{display:block;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(15px);}to{opacity:1;transform:translateY(0);}}
    .chat-bubble{max-width:70%;padding:10px 14px;margin:6px;border-radius:18px;word-wrap:break-word;font-size:15px;animation:popIn .3s ease;}
    @keyframes popIn{from{transform:scale(.8);opacity:0;}to{transform:scale(1);opacity:1;}}
    .me{background:#ff0050;color:#fff;margin-left:auto;} .other{background:#222;color:#fff;margin-right:auto;}
    .list-item{display:flex;align-items:center;gap:10px;padding:8px;border-bottom:1px solid #333;cursor:pointer;}
    .list-item img{width:40px;height:40px;border-radius:50%;object-fit:cover;}
    .chat-header{display:flex;align-items:center;gap:10px;padding:5px;border-bottom:1px solid #333;}
    .chat-header img{width:45px;height:45px;border-radius:50%;}
    .btn-tiktok{background:linear-gradient(45deg,#ff0050,#00f2ea);border:none;color:#fff;font-weight:bold;border-radius:25px;}
    .btn-tiktok:hover{opacity:.85;}
    .card{background:#111;color:#fff;}
    input,select{background:#222!important;color:#fff!important;border:none!important;}
    body.light{background:#f0f2f5;color:#000;}
    body.light .card{background:#fff;color:#000;}
    body.light input,body.light select{background:#fff!important;color:#000!important;border:1px solid #ccc!important;}
    body.light .me{background:#1877f2;color:#fff;} body.light .other{background:#e9ecef;color:#111;}
    body.light .list-item{border-bottom:1px solid #ccc;}
  </style>
</head>
<body class="container py-3">

  <!-- Navigation -->
  <div class="mb-3 text-center">
    <button class="btn btn-tiktok" onclick="showPage('registerPage')">ğŸ  ØªØ³Ø¬ÙŠÙ„</button>
    <button class="btn btn-tiktok" onclick="showPage('searchPage')">ğŸ” Ø¨Ø­Ø«</button>
    <button class="btn btn-tiktok" onclick="showPage('requestsPage')">ğŸ“¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
    <button class="btn btn-tiktok" onclick="showPage('friendsPage')">ğŸ‘¥ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡</button>
    <button class="btn btn-warning" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
    <button class="btn btn-secondary" onclick="toggleTheme()">ğŸŒ“ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø«ÙŠÙ…</button>
  </div>

  <!-- Register -->
  <section id="registerPage">
    <div class="card p-4 shadow-lg">
      <h4 class="mb-3 text-center">ğŸš€ ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨</h4>
      <input id="regName" type="text" class="form-control mb-2" placeholder="âœï¸ Ø§Ù„Ø§Ø³Ù…">
      <input id="regAge" type="number" class="form-control mb-2" placeholder="ğŸ‚ Ø§Ù„Ø¹Ù…Ø±">
      <select id="regGender" class="form-select mb-2">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù†Ø³</option><option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option><option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
      </select>
      <input id="regPhoto" type="file" accept="image/*" class="form-control mb-2">
      <button id="btnContinue" class="btn btn-tiktok w-100" disabled>Ù…ØªØ§Ø¨Ø¹Ø©</button>
    </div>
  </section>

  <!-- Search -->
  <section id="searchPage">
    <h4>ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h4>
    <div class="input-group mb-3">
      <input id="searchInput" type="search" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
      <button id="btnSearch" class="btn btn-tiktok">Ø¨Ø­Ø«</button>
    </div>
    <div id="searchResults"></div>
  </section>

  <!-- Requests -->
  <section id="requestsPage">
    <h4>ğŸ“¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h4>
    <div id="requestsList"></div>
  </section>

  <!-- Friends -->
  <section id="friendsPage">
    <h4>ğŸ‘¥ Ø£ØµØ¯Ù‚Ø§Ø¦ÙŠ</h4>
    <div id="friendsList"></div>
  </section>

  <!-- Chat -->
  <section id="chatPage">
    <div class="chat-header">
      <img id="chatFriendImg" src=""><h5 id="chatFriend"></h5>
    </div>
    <div id="messagesArea" style="height:55vh;overflow:auto;" class="mb-2 p-2 rounded bg-dark"></div>
    <div class="input-group mb-2">
      <input id="msgInput" type="text" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
      <button id="btnSend" class="btn btn-tiktok">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
    <button id="btnRecord" class="btn btn-danger w-100">ğŸ¤ Ø§Ø¶ØºØ· Ù„ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª</button>
  </section>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDQmWof8RhM8yef5MQDQ2Cc3KtMr7RQVHA",
      authDomain: "djasser-137e1.firebaseapp.com",
      databaseURL: "https://djasser-137e1-default-rtdb.firebaseio.com",
      projectId: "djasser-137e1",
      storageBucket: "djasser-137e1.appspot.com",
      messagingSenderId: "204637393208",
      appId: "1:204637393208:web:236fea510daa1d0f66f1cd"
    };
    firebase.initializeApp(firebaseConfig);
    const auth=firebase.auth(), db=firebase.database(), storage=firebase.storage();

    let currentUser=null,currentProfile=null,chatRef=null,chatFriendUid=null;
    let mediaRecorder=null,audioChunks=[];

    function $(id){return document.getElementById(id);}
    function showPage(id){document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));$(id).classList.add("active");}
    function toggleTheme(){document.body.classList.toggle("light");}

    // ØªÙØ¹ÙŠÙ„ Ø²Ø± Ù…ØªØ§Ø¨Ø¹Ø©
    function checkRegisterFields(){
      $("btnContinue").disabled = !(
        $("regName").value.trim() &&
        $("regAge").value.trim() &&
        $("regGender").value &&
        $("regPhoto").files.length>0
      );
    }
    ["regName","regAge","regGender","regPhoto"].forEach(id=>{
      $(id).addEventListener("input",checkRegisterFields);
      $(id).addEventListener("change",checkRegisterFields);
    });

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„/Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
    $("btnContinue").onclick=()=>{
      auth.signInAnonymously().then(res=>{
        currentUser=res.user;
        let file=$("regPhoto").files[0];
        let ref=storage.ref("profiles/"+currentUser.uid+".jpg");
        ref.put(file).then(snap=>snap.ref.getDownloadURL()).then(url=>{
          let profile={uid:currentUser.uid,name:$("regName").value,age:$("regAge").value,gender:$("regGender").value,photo:url};
          db.ref("users/"+currentUser.uid).set(profile).then(()=>{
            currentProfile=profile;
            localStorage.setItem("profile",JSON.stringify(profile));
            loadFriends(); loadRequests();
            showPage("friendsPage");
          });
        });
      });
    };

    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø­Ø³Ø§Ø¨ Ù…Ø­Ù„ÙŠ
    window.onload=()=>{
      let saved=localStorage.getItem("profile");
      if(saved){
        currentProfile=JSON.parse(saved);
        auth.signInAnonymously().then(u=>{
          currentUser=u.user;
          loadFriends(); loadRequests(); showPage("friendsPage");
        });
      } else {showPage("registerPage");}
    };

    // Ø§Ù„Ø¨Ø­Ø«
    $("btnSearch").onclick=()=>{
      let q=$("searchInput").value.trim();
      $("searchResults").innerHTML="";
      if(!q) return;
      db.ref("users").orderByChild("name").startAt(q).endAt(q+"\uf8ff").once("value",snap=>{
        snap.forEach(c=>{
          let u=c.val(); if(u.uid===currentUser.uid) return;
          let div=document.createElement("div");
          div.className="list-item";
          div.innerHTML=`<img src="${u.photo||''}"><span>${u.name} (${u.age})</span>`;
          div.onclick=()=>sendRequest(u.uid);
          $("searchResults").appendChild(div);
        });
      });
    };
    function sendRequest(toUid){
      let reqId=db.ref("friendRequests").push().key;
      db.ref("friendRequests/"+reqId).set({from:currentUser.uid,to:toUid});
    }

    // Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    function loadRequests(){
      db.ref("friendRequests").on("value",snap=>{
        $("requestsList").innerHTML="";
        snap.forEach(c=>{
          let r=c.val();
          if(r.to===currentUser.uid){
            db.ref("users/"+r.from).once("value",usnap=>{
              let u=usnap.val();
              let div=document.createElement("div");
              div.className="list-item";
              div.innerHTML=`<img src="${u.photo||''}"><span>${u.name} ÙŠØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØªÙƒ</span>
              <button class="btn btn-sm btn-success ms-auto">Ù‚Ø¨ÙˆÙ„</button>`;
              div.querySelector("button").onclick=()=>{
                const now=Date.now();
                db.ref("friends/"+currentUser.uid+"/"+r.from).set({uid:r.from,since:now});
                db.ref("friends/"+r.from+"/"+currentUser.uid).set({uid:currentUser.uid,since:now});
                db.ref("friendRequests/"+c.key).remove();
              };
              $("requestsList").appendChild(div);
            });
          }
        });
      });
    }

    // Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
    function loadFriends(){
      db.ref("friends/"+currentUser.uid).on("value",snap=>{
        $("friendsList").innerHTML="";
        snap.forEach(c=>{
          db.ref("users/"+c.key).once("value",usnap=>{
            let u=usnap.val();
            let div=document.createElement("div");
            div.className="list-item";
            div.innerHTML=`<img src="${u.photo||''}"><span>${u.name} (${u.age})</span>`;
            div.onclick=()=>openChat(u.uid,u.name,u.photo);
            $("friendsList").appendChild(div);
          });
        });
      });
    }

    // Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
    function openChat(friendUid,friendName,photo){
      showPage("chatPage");
      $("chatFriend").textContent=friendName;
      $("chatFriendImg").src=photo||"";
      $("messagesArea").innerHTML="";
      chatFriendUid=friendUid;
      let chatId=currentUser.uid<friendUid? currentUser.uid+"_"+friendUid : friendUid+"_"+currentUser.uid;
      chatRef=db.ref("chats/"+chatId); chatRef.off();
      chatRef.on("child_added",snap=>{
        let m=snap.val(); let div=document.createElement("div");
        div.className="chat-bubble "+(m.from===currentUser.uid?"me":"other");
        if(m.type==="text") div.textContent=m.text;
        if(m.type==="audio") div.innerHTML=`<audio controls src="${m.url}"></audio>`;
        $("messagesArea").appendChild(div);
        $("messagesArea").scrollTop=$("messagesArea").scrollHeight;
      });
    }

    $("btnSend").onclick=()=>{
      let text=$("msgInput").value.trim();
      if(text && chatRef){
        chatRef.push({from:currentUser.uid,type:"text",text,ts:Date.now()});
        $("msgInput").value="";
      }
    };

    // ğŸ¤ ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª (Ø±Ø­ ÙŠØ·Ù„Ø¨ Ø¥Ø°Ù† Ù…Ù† Ø¬ÙˆØ¬Ù„ Ø£ÙˆÙ„ Ù…Ø±Ø©)
    async function startRecording(){
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks=[];
        mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
        mediaRecorder.onstop=()=>{
          let blob=new Blob(audioChunks,{type:"audio/webm"});
          let fileName="voice_"+Date.now()+".webm";
          let ref=storage.ref("chatVoices/"+fileName);
          ref.put(blob).then(snap=>snap.ref.getDownloadURL()).then(url=>{
            chatRef.push({from:currentUser.uid,type:"audio",url,ts:Date.now()});
          });
        };
        mediaRecorder.start();
        $("btnRecord").textContent="âºï¸ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...";
      } catch(e){
        alert("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†. Ø§ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¹Ø¨Ø± HTTPS ÙˆÙ…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù†.");
        console.error(e);
      }
    }
    $("btnRecord").onmousedown=startRecording;
    $("btnRecord").onmouseup=()=>{if(mediaRecorder && mediaRecorder.state==="recording"){mediaRecorder.stop();$("btnRecord").textContent="ğŸ¤ Ø§Ø¶ØºØ· Ù„ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª";}};

    function logout(){localStorage.removeItem("profile");auth.signOut();showPage("registerPage");}
  </script>
</body>
</html>
